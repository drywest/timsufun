<!doctype html>
}


function renderMessage(msg){
const el = document.createElement('div');
el.className = 'msg';


const avatar = document.createElement('div');
avatar.className = 'avatar';
avatar.textContent = msg.author.slice(0,1).toUpperCase();
avatar.style.background = colorForName(msg.author);


const body = document.createElement('div');
body.className = 'body';


const author = document.createElement('div');
author.className = 'author';
author.textContent = msg.author;
author.style.color = colorForName(msg.author);


const text = document.createElement('div');
text.className = 'text';
text.innerHTML = escapeHtml(msg.text || '');


// if long message, add marquee class for fast movement
if ((msg.text||'').length > 80) text.classList.add('marquee');


body.appendChild(author);
body.appendChild(text);


el.appendChild(avatar);
el.appendChild(body);


// prepend (since container is column-reverse for push-up)
messagesEl.prepend(el);


// keep only N messages for perf
const max = 35;
while (messagesEl.children.length > max) messagesEl.removeChild(messagesEl.lastChild);
}


function escapeHtml(s){
return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}


function connectSSE(videoId){
const url = new URL(PROXY_BASE);
url.searchParams.set('videoId', videoId);


const evt = new EventSource(url.toString(), { withCredentials: false });


evt.addEventListener('message', e => {
try{
const data = JSON.parse(e.data);
renderMessage(data);
}catch(err){ console.warn('invalid message', e.data); }
});


evt.addEventListener('error', e => {
console.warn('sse error', e);
});


evt.addEventListener('error', e => {
// try reconnect logic
});


return evt;
}


// connect if video id is present
if (VIDEO_ID) connectSSE(VIDEO_ID);
else {
// if no videoId in URL, show helpful overlay text
const hint = document.createElement('div');
hint.style.position='absolute';hint.style.top='50%';hint.style.left='50%';hint.style.transform='translate(-50%,-50%)';hint.style.color='white';hint.style.fontSize='18px';hint.style.background='rgba(0,0,0,0.5)';hint.style.padding='8px 12px';hint.style.borderRadius='8px';
hint.textContent='No videoId provided. Add ?videoId=VIDEO_ID to the overlay URL (or supply proxy param too).';
document.body.appendChild(hint);
}


</script>
</body>
</html>
