<!-- public/overlay.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YT Live Chat Overlay</title>
<style>
  :root { --bg: transparent; }
  html,body{height:100%;margin:0;background:transparent}
  .chat-wrap{position:relative;width:100%;height:100%;overflow:hidden;padding:10px;box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:white}
  .messages{position:absolute;bottom:10px;left:10px;right:10px;display:flex;flex-direction:column-reverse;gap:8px;pointer-events:none}
  .msg{display:flex;align-items:flex-start;gap:10px;max-width:88vw;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.35);backdrop-filter: blur(4px);box-shadow:0 8px 24px rgba(0,0,0,0.45);transform-origin:left bottom;animation: pushUp 320ms cubic-bezier(.2,.9,.3,1) both;pointer-events:auto;overflow:hidden}
  .avatar{width:38px;height:38px;border-radius:50%;flex:0 0 38px;display:grid;place-items:center;font-weight:700;color:white}
  .body{display:flex;flex-direction:column;min-width:0}
  .author{font-weight:800;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .text{font-size:15px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .yt-emoji{height:18px;vertical-align:middle;margin:0 2px}
  @keyframes pushUp{from{transform:translateY(8px) scale(.995);opacity:0}to{transform:none;opacity:1}}
  .text.marquee{display:inline-block;padding-left:8px;animation: scroll 10s linear infinite}
  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-40%)}}
  @media (max-width:600px){ .messages{left:6px;right:6px} }
</style>
</head>
<body>
  <div class="chat-wrap">
    <div id="messages" class="messages" aria-live="polite"></div>
  </div>

<script>
  // overlay.html?key=KEY  (key from the UI)
  const params = new URLSearchParams(location.search);
  const KEY = params.get('key');
  if (!KEY) {
    document.body.innerHTML = '<div style="color:white;padding:20px">No key provided. Use ?key=YOURKEY in the overlay URL.</div>';
    throw new Error('no key');
  }

  const messagesEl = document.getElementById('messages');

  function colorForName(name){
    const colors = ['#ff4d4f','#ff7a18','#f5a623','#f8e71c','#7ed321','#50e3c2','#4a90e2','#9013fe','#d0021b','#f78da7'];
    let h = 2166136261 >>> 0;
    for (let i = 0; i < name.length; i++) h = Math.imul(h ^ name.charCodeAt(i), 16777619) >>> 0;
    return colors[h % colors.length];
  }

  function renderMessage(msg) {
    const el = document.createElement('div');
    el.className = 'msg';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = msg.author?.slice(0,1).toUpperCase() || '?';
    const bg = colorForName(msg.author || 'anon');
    avatar.style.background = bg;

    const body = document.createElement('div');
    body.className = 'body';

    const author = document.createElement('div');
    author.className = 'author';
    author.textContent = msg.author || 'unknown';
    author.style.color = bg;

    const text = document.createElement('div');
    text.className = 'text';
    text.innerHTML = msg.text || '';

    if ((msg.text || '').length > 80) text.classList.add('marquee');

    body.appendChild(author);
    body.appendChild(text);
    el.appendChild(avatar);
    el.appendChild(body);

    messagesEl.prepend(el);

    const max = 45;
    while (messagesEl.children.length > max) messagesEl.removeChild(messagesEl.lastChild);
  }

  // Connect SSE to the server's /sse?key=KEY
  const sseUrl = new URL('/sse', location.origin);
  sseUrl.searchParams.set('key', KEY);

  const evt = new EventSource(sseUrl.toString(), { withCredentials: false });

  evt.addEventListener('message', e => {
    // 'message' events carry chat messages
    try {
      const data = JSON.parse(e.data);
      renderMessage(data);
    } catch (err) {
      console.warn('invalid message', e.data, err);
    }
  });

  evt.addEventListener('error', e => {
    console.warn('SSE error', e);
  });

  // For debug: show SSE info events (info/error)
  evt.addEventListener('info', e => {
    try {
      const d = JSON.parse(e.data);
      console.info('info', d);
    } catch {}
  });
  evt.addEventListener('error', e => {
    try {
      const d = JSON.parse(e.data);
      console.error('server error', d);
    } catch {}
  });

</script>
</body>
</html>
