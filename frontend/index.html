<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Merged Chat Overlay</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0b0b;--panel:#121212;--muted:#9aa0a6;--accent:#ff0000}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Arial;color:#eee}
    .app{padding:12px;max-width:1000px;margin:8px auto}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .logo{font-weight:800;color:var(--accent)}
    .controls{display:flex;gap:8px}
    .btn{background:#161616;border:1px solid #222;padding:8px 10px;border-radius:8px;color:#ddd;text-decoration:none}
    .chat{background:linear-gradient(#080808,#0f0f10);border-radius:8px;padding:8px;height:60vh;overflow:auto;border:1px solid #222}
    .line{display:flex;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .avatar{width:36px;height:36px;border-radius:50%;background:#222}
    .meta{flex:1}
    .name{font-weight:700;margin-right:8px}
    .platform{font-size:11px;padding:3px 6px;border-radius:6px;color:#fff;margin-left:8px}
    .platform.youtube{background:#cc0000}
    .platform.twitch{background:#6441a5}
    .send-row{display:flex;gap:8px;margin-top:10px}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#fff}
    .send{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff}
    label {display:flex;align-items:center;gap:6px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="logo">MergedChat</div>
      <div class="controls">
        <button id="connectTwitch" class="btn">Connect Twitch (read)</button>
        <button id="runYTBridge" class="btn">YT Bridge: Start (optional)</button>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <form id="sendForm" class="send-row">
      <input id="text" type="text" placeholder="Send message to all connected platforms..." autocomplete="off" />
      <label><input id="sendAll" type="checkbox" checked /> Send to all</label>
      <button class="send" type="submit">Send</button>
    </form>

    <div class="small">Notes: For sending to YouTube/Twitch automatically you must install the companion browser extension and be logged into YouTube & Twitch in that browser. YouTube read requires the optional YT bridge if you want to show YT messages without API keys.</div>
  </div>

  <script>
  // ---------- merged chat UI + Twitch anonymous reader (browser WebSocket to IRC) ----------
  const chatEl = document.getElementById('chat');
  const connectTwitchBtn = document.getElementById('connectTwitch');
  const runYTBridgeBtn = document.getElementById('runYTBridge');

  let twitchSocket = null;
  let twitchChannel = null;

  function appendMessage({platform, author, text, avatar, color}) {
    const div = document.createElement('div');
    div.className = 'line';
    div.innerHTML = `
      <div class="avatar"></div>
      <div class="meta">
        <div><span class="name" style="color:${color||'#9ae'}">${author}</span><span class="platform ${platform}">${platform}</span></div>
        <div>${escapeHtml(text)}</div>
      </div>
    `;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }

  // Connect to Twitch chat as an anonymous client (no secrets) and join the channel you specify.
  // This only reads messages.
  connectTwitchBtn.onclick = async () => {
    const ch = prompt('Enter the Twitch channel name to read (e.g. some_streamer)').trim().toLowerCase();
    if(!ch) return;
    twitchChannel = ch;
    if (twitchSocket) try { twitchSocket.close(); } catch(e){}
    twitchSocket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

    twitchSocket.addEventListener('open', () => {
      // request tags for richer messages
      twitchSocket.send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
      // anonymous nick
      const nick = 'justinfan' + Math.floor(Math.random()*100000);
      twitchSocket.send('NICK ' + nick);
      twitchSocket.send('JOIN #' + ch);
      appendMessage({platform:'twitch',author:'system',text:'Connected (anonymous) to #' + ch});
    });

    twitchSocket.addEventListener('message', (ev) => {
      const raw = ev.data;
      // simple parse for PRIVMSG lines
      // Example raw includes tags: @badge-info=...;display-name=Author;... PRIVMSG #channel :message text
      if (raw.includes('PRIVMSG')) {
        try {
          const parts = raw.split(' PRIVMSG ');
          const left = parts[0]; // tags and author
          const right = parts[1]; // "#channel :message"
          const message = right.split(' :').slice(1).join(' :').trim();
          // try parse display-name from tags
          const tagPart = left.startsWith('@') ? left.split(' ')[0].substr(1) : '';
          const tags = Object.fromEntries(tagPart.split(';').map(p=>{const [k,v]=p.split('='); return [k,v]}));
          const author = tags['display-name'] || (left.split('!')[0].replace(':','')) || 'twitch_user';
          const color = tags['color'] || null;
          appendMessage({platform:'twitch',author, text: message, color});
        } catch(e){ /* ignore parse errors */ }
      }
      // join/part/state etc ignored
    });

    twitchSocket.addEventListener('close', ()=> appendMessage({platform:'twitch',author:'system',text:'Twitch socket closed'}));
    twitchSocket.addEventListener('error', ()=> appendMessage({platform:'twitch',author:'system',text:'Twitch socket error'}));
  };

  // ---------- Optional YT Bridge (websocket) ----------
  // If you run the YT bridge (C# service below), point it at ws://localhost:4000 (default)
  let ytSocket = null;
  runYTBridgeBtn.onclick = async () => {
    if (ytSocket && ytSocket.readyState === WebSocket.OPEN) { ytSocket.close(); ytSocket = null; runYTBridgeBtn.textContent = 'YT Bridge: Start (optional)'; return; }
    const wsUrl = prompt('Enter YT bridge websocket URL (example: ws://localhost:4000)') || 'ws://localhost:4000';
    ytSocket = new WebSocket(wsUrl);
    ytSocket.addEventListener('open', () => { appendMessage({platform:'youtube',author:'system',text:'YT bridge connected'}) ; runYTBridgeBtn.textContent = 'YT Bridge: Stop';});
    ytSocket.addEventListener('message', e => {
      // expects JSON messages { author, text }
      try{
        const data = JSON.parse(e.data);
        appendMessage({platform:'youtube', author: data.author || 'yt', text: data.text});
      }catch(err){}
    });
    ytSocket.addEventListener('close', ()=> { appendMessage({platform:'youtube',author:'system',text:'YT bridge closed'}); runYTBridgeBtn.textContent = 'YT Bridge: Start (optional)';});
    ytSocket.addEventListener('error', ()=> appendMessage({platform:'youtube',author:'system',text:'YT bridge error'}));
  };

  // ---------- Send flow: page posts to window; extension reads it ----------
  const sendForm = document.getElementById('sendForm');
  sendForm.addEventListener('submit', (ev) => {
    ev.preventDefault();
    const txt = document.getElementById('text').value.trim();
    if(!txt) return;
    const sendAll = document.getElementById('sendAll').checked;
    // first echo locally
    appendMessage({platform:'local',author:'you',text: txt, color:'#8ae'});
    // send a window.postMessage event for the extension to pick up and dispatch to Twitch/YouTube tabs
    window.postMessage({ type: 'MERGEDCHAT_SEND', payload: { text: txt, sendAll } }, '*');
    document.getElementById('text').value = '';
  });

  // optional: also support pressing a keyboard shortcut to send
  window.addEventListener('message', (ev) => {
    // we do not expect messages from extension to page for now
  }, false);

  </script>
</body>
</html>
